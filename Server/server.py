# -*- coding: UTF-8 -*-
from flask import Flask, jsonify, render_template, request, json  # From module flask import class Flask
from flask import make_response

from Database.database import db_session, init_db
from Database.models import User, Report

app = Flask(__name__)  # Construct an instance of Flask class for our webapp


@app.teardown_appcontext
def shutdown_session(exception=None):
    db_session.remove()


@app.route('/sismic/registration_form', methods=['POST'])
def handle_registration():
    email = request.args.get('email')
    password = request.args.get('secret')
    name = request.args.get('name')
    address = request.args.get('address')
    phone = request.args.get('phone')
    qualification = request.args.get('qualification')
    register = request.args.get('register')
    if email is None or password is None:
        make_response("", 560)  # missing arguments
    if User.query.filter_by(email=email).first() is not None:
        make_response("", 561)  # existing user

    user = User(email, password, name, address, phone, qualification, register)
    db_session.add(user)
    db_session.commit()
    return make_response("success", 200)


@app.route('/sismic/login_form', methods=['POST'])
def handle_login():
    email = request.args.get('email')
    password = request.args.get('secret')
    user = User.query.filter_by(email=email).first()
    if not user:
        return make_response("user not present", 550)
    else:
        if user.verify_password(password):
            response = jsonify(user.toDict())
            response.status_code = 200
            return response
        else:
            return make_response("invalid psw", 551)


@app.route('/sismic/reports', methods=["GET"])
def show_reports():
    reportsQueryResult = Report.query.all()
    reports = []
    for report in reportsQueryResult:
        reports.append(json.dumps(report.data, sort_keys=True, indent=4, separators=(',', ': ')))

    return render_template("results.html", reports=reports, mimetype='application/json')


@app.route('/sismic/upload_report', methods=["POST"])
def upload_report():
    data = request.json
    if data is None:
        return make_response("Impossibile leggere il report", 666)
    print(data)
    email = request.args.get('email')
    report = Report(json.dumps(data), email)
    db_session.add(report)
    db_session.commit()
    return make_response("success", 200)


@app.route('/sismic/upload_report_files', methods=["POST"])
def upload_file():
    pass


@app.route('/')
def main():
    # test = '{"reportDetails":{"committed":1,"date":"Oct 14, 2017 12:22:17","id":10,"pdf_path":"content://com.polito.sismic/media/files/Documents/verifica_sismica_Corso%20Duca%20degli%20Abruzzi_2017-10-14%2012%3A22%3A17%20.pdf","title":"Corso Duca degli Abruzzi","userIdentifier":"Matteo"},"reportState":{"buildingState":{"buildingGeneralState":{"anno_costruzione":"\u003c 1919","stato_edificio":"Finito","tipologia_strutturale":"Muratura","totale_unita":"Totalmente utilizzato"},"pillarLayoutState":{"area":8.333333333333334,"distX":5.0,"distY":5.0,"pillarCount":6,"pillarX":3,"pillarY":2},"pillarState":{"E":210000.0,"area_ferri":508.93800988154646,"bx":300.0,"c":30.0,"classe_acciaio":"B450C","classe_calcestruzzo":"C25/30","conoscenza_acciaio":1.0,"conoscenza_calcestruzzo":1.0,"diametro_ferri":18.0,"ecm":31475.806210019346,"eps2":2.0,"epsu":3.5,"epsy":10.0,"epsyu":67.5,"fcd":14.166666666666666,"fck":25.0,"fcm":33.0,"fyd":391.304347826087,"fyk":450.0,"hy":300.0,"num_ferri":2,"pillar_domain":{"domainPoints":[{"m":0.0,"n":-398.2993120812103},{"m":47.79591744974524,"n":0.0},{"m":56.88029244974524,"n":63.75},{"m":65.00841744974524,"n":127.5},{"m":72.18029244974524,"n":191.25},{"m":78.39591744974524,"n":255.0},{"m":83.65529244974523,"n":318.75},{"m":87.95841744974524,"n":382.5},{"m":91.30529244974524,"n":446.25},{"m":93.69591744974524,"n":510.0},{"m":95.13029244974524,"n":573.75},{"m":95.60841744974523,"n":637.5},{"m":95.13029244974524,"n":701.25},{"m":93.69591744974524,"n":765.0},{"m":91.30529244974524,"n":828.75},{"m":87.95841744974524,"n":892.5},{"m":83.65529244974523,"n":956.25},{"m":78.39591744974524,"n":1020.0},{"m":72.18029244974524,"n":1083.75},{"m":65.00841744974524,"n":1147.5},{"m":56.88029244974524,"n":1211.25},{"m":47.79591744974524,"n":1275.0},{"m":0.0,"n":1673.2993120812102}],"limitStatePoints":[{"color":2131099801,"fn":0.10356460580108115,"label":"SLO","lambda":1.0,"m":0.9320814522097303,"n":59.041666666666664,"sd":0.1862262636423111,"t1":0.1709630292716083},{"color":2131099800,"fn":0.12851028957841343,"label":"SLD","lambda":1.0,"m":1.1565926062057208,"n":59.041666666666664,"sd":0.2310827225446701,"t1":0.1709630292716083},{"color":2131099802,"fn":0.264202776460015,"label":"SLV","lambda":1.0,"m":2.377824988140135,"n":59.041666666666664,"sd":0.4750802218914032,"t1":0.1709630292716083},{"color":2131099799,"fn":0.31966827414473703,"label":"SLC","lambda":1.0,"m":2.8770144673026334,"n":59.041666666666664,"sd":0.5748163461685181,"t1":0.1709630292716083},{"color":2131099752,"fn":0.0,"label":"MRD","lambda":0.0,"m":56.24205940235962,"n":59.041666666666664,"sd":0.0,"t1":0.0}]},"rck":30.0},"structuralState":{"altezza_fondazioni":2.0,"g2_copertura":2.35,"g2_solaio":0.0,"peso_copertura":2.5,"peso_copertura_string":"12+4","peso_solaio":2.5,"peso_solaio_string":"12+4","peso_totale":5.449999999999999,"q_copertura":5.449999999999999,"q_solaio":0.0,"qk_copertura":2.0,"qk_solaio":0.0,"tipo_copertura":"Latero-cemento","tipo_fondazioni":"Platea","tipo_solaio":"Latero-cemento"},"takeoverState":{"altezza_piani_superiori":0.0,"altezza_piano_terra":3.0,"altezza_totale":3.0,"area":2.5000000000000004,"gravity_center":{"x":30.0,"y":5.000000000000001},"numero_piani":1,"perimetro":0.1709630292716083,"plant_points":[{"x":0.0,"y":0.0},{"x":10.0,"y":0.0},{"x":10.0,"y":5.0},{"x":0.0,"y":5.0},{"x":0.0,"y":0.0}],"t1":50.0}},"generalState":{"catastoState":{"aggr_str":"","edificio":"","foglio":"","foglio_cartografia":"","mappale":"","particella":"","piano_urb":"","vincoli_urb":"","zona_urb":""}},"localizationState":{"address":"Corso Duca degli Abruzzi","cap":"31313","code":"1272","comune":"Torino","country":"Italia","latitude":45.0602,"longitude":7.6611,"province":"TO","region":"Piemonte","zone":"4","zone_int":4},"mediaState":[],"result":{"result":60,"size":0.0},"sismicState":{"projectSpectrumState":{"alfa":1.1,"categoria_suolo":"A","categoria_topografica":1.0,"classe_duttilita":false,"kr":1.0,"q0":3.3000000000000003,"spectrums":[{"ag":0.2389816745709031,"cc":1.0,"color":2131099801,"f0":2.571522246195577,"name":"SLO","ni":0.303030303030303,"pointList":[{"x":0.0,"y":0.2389816790819168},{"x":0.05999999865889549,"y":0.1862262636423111},{"x":0.18000000715255737,"y":0.1862262636423111},{"x":0.18000000715255737,"y":0.1862262636423111},{"x":0.25587716698646545,"y":0.13100320100784302},{"x":0.3317543566226959,"y":0.1010408103466034},{"x":0.407631516456604,"y":0.08223291486501694},{"x":0.4835087060928345,"y":0.06932807713747025},{"x":0.5593858957290649,"y":0.059924159198999405},{"x":0.6352630853652954,"y":0.05276668816804886},{"x":0.7111402153968811,"y":0.047136593610048294},{"x":0.7870174050331116,"y":0.04259210452437401},{"x":0.862894594669342,"y":0.03884683921933174},{"x":0.9387717843055725,"y":0.035707004368305206},{"x":1.0146489143371582,"y":0.03303677588701248},{"x":1.0905261039733887,"y":0.03073812462389469},{"x":1.1664032936096191,"y":0.028738541528582573},{"x":1.2422804832458496,"y":0.026983220130205154},{"x":1.31815767288208,"y":0.0254299845546484},{"x":1.3940348625183105,"y":0.024045832455158234},{"x":1.469912052154541,"y":0.022804582491517067},{"x":1.5457892417907715,"y":0.02168518863618374},{"x":1.6216663122177124,"y":0.02067054621875286},{"x":1.6975435018539429,"y":0.019746609032154083},{"x":1.6975435018539429,"y":0.019746609032154083},{"x":1.812666416168213,"y":0.017318034544587135},{"x":1.9277892112731934,"y":0.015311413444578648},{"x":2.042912006378174,"y":0.013634368777275085},{"x":2.1580348014831543,"y":0.01221848838031292},{"x":2.2731575965881348,"y":0.011012230068445206},{"x":2.3882803916931152,"y":0.009976167231798172},{"x":2.5034031867980957,"y":0.009079725481569767},{"x":2.6185262203216553,"y":0.008298899978399277},{"x":2.7336490154266357,"y":0.007614631671458483},{"x":2.848771810531616,"y":0.007011631038039923},{"x":2.9638946056365967,"y":0.0064775217324495316},{"x":3.079017400741577,"y":0.0060021947138011456},{"x":3.1941401958465576,"y":0.005577330943197012},{"x":3.309262990951538,"y":0.005196031648665667},{"x":3.4243857860565186,"y":0.004852538462728262},{"x":3.539508819580078,"y":0.004542013164609671},{"x":3.6546316146850586,"y":0.004260368645191193},{"x":3.769754409790039,"y":0.004004131071269512},{"x":3.8848772048950195,"y":0.0037703337147831917}],"q":3.3000000000000003,"s":1.0,"ss":1.0,"st":1.0,"tb":0.05999999999999999,"tc":0.17999999999999997,"tcStar":0.17999999999999997,"td":1.697543540641185,"year":30},{"ag":0.29515875502994277,"cc":1.0,"color":2131099800,"f0":2.5836028140162193,"name":"SLD","ni":0.303030303030303,"pointList":[{"x":0.0,"y":0.2951587438583374},{"x":0.06477220356464386,"y":0.2310827225446701},{"x":0.19431662559509277,"y":0.2310827225446701},{"x":0.19431662559509277,"y":0.2310827225446701},{"x":0.27062442898750305,"y":0.16592445969581604},{"x":0.3469322621822357,"y":0.12942934036254883},{"x":0.423240065574646,"y":0.10609395802021027},{"x":0.49954789876937866,"y":0.08988770842552185},{"x":0.5758557319641113,"y":0.07797650247812271},{"x":0.6521635055541992,"y":0.06885269284248352},{"x":0.7284713387489319,"y":0.06164032965898514},{"x":0.8047791719436646,"y":0.05579569563269615},{"x":0.8810869455337524,"y":0.05096342787146568},{"x":0.9573947787284851,"y":0.046901460736989975},{"x":1.0337026119232178,"y":0.04343919828534126},{"x":1.1100103855133057,"y":0.04045296460390091},{"x":1.186318278312683,"y":0.03785090148448944},{"x":1.262626051902771,"y":0.03556334972381592},{"x":1.3389338254928589,"y":0.03353654220700264},{"x":1.4152417182922363,"y":0.03172830119729042},{"x":1.4915494918823242,"y":0.030105076730251312},{"x":1.5678573846817017,"y":0.028639858588576317},{"x":1.6441651582717896,"y":0.027310647070407867},{"x":1.7204729318618774,"y":0.026099342852830887},{"x":1.7204729318618774,"y":0.026099342852830887},{"x":1.834449291229248,"y":0.022956931963562965},{"x":1.9484256505966187,"y":0.02034967951476574},{"x":2.0624020099639893,"y":0.018162624910473824},{"x":2.1763782501220703,"y":0.01631009392440319},{"x":2.2903547286987305,"y":0.014727186411619186},{"x":2.4043309688568115,"y":0.013364008627831936},{"x":2.5183074474334717,"y":0.012181696482002735},{"x":2.6322836875915527,"y":0.011149615049362183},{"x":2.746260166168213,"y":0.010243347845971584},{"x":2.860236406326294,"y":0.009443247690796852},{"x":2.974212884902954,"y":0.00873335637152195},{"x":3.088189125061035,"y":0.008100605569779873},{"x":3.2021656036376953,"y":0.007534210104495287},{"x":3.3161418437957764,"y":0.007025205995887518},{"x":3.4301183223724365,"y":0.006566093768924475},{"x":3.5440945625305176,"y":0.006150559987872839},{"x":3.6580710411071777,"y":0.005773258861154318},{"x":3.772047281265259,"y":0.00542963994666934},{"x":3.886023759841919,"y":0.005115809850394726},{"x":4.0,"y":0.004828422795981169}],"q":3.3000000000000003,"s":1.0,"ss":1.0,"st":1.0,"tb":0.06477220605437957,"tc":0.1943166181631387,"tcStar":0.1943166181631387,"td":1.7204729612367113,"year":50},{"ag":0.5685658035385494,"cc":1.0,"color":2131099802,"f0":2.7574024893056834,"name":"SLV","ni":0.303030303030303,"pointList":[{"x":0.0,"y":0.5685657858848572},{"x":0.08998104929924011,"y":0.4750802218914032},{"x":0.26994314789772034,"y":0.4750802218914032},{"x":0.26994314789772034,"y":0.4750802218914032},{"x":0.3480493724346161,"y":0.3684668242931366},{"x":0.42615559697151184,"y":0.3009338676929474},{"x":0.5042617917060852,"y":0.25432154536247253},{"x":0.5823680758476257,"y":0.22021237015724182},{"x":0.6604743003845215,"y":0.19417054951190948},{"x":0.7385805249214172,"y":0.17363665997982025},{"x":0.816686749458313,"y":0.1570304036140442},{"x":0.8947929739952087,"y":0.14332327246665955},{"x":0.9728991985321045,"y":0.13181699812412262},{"x":1.0510053634643555,"y":0.12202092260122299},{"x":1.129111647605896,"y":0.1135801300406456},{"x":1.207217812538147,"y":0.10623157024383545},{"x":1.2853240966796875,"y":0.09977611899375916},{"x":1.3634302616119385,"y":0.09406028687953949},{"x":1.441536545753479,"y":0.08896385878324509},{"x":1.51964271068573,"y":0.08439131081104279},{"x":1.5977489948272705,"y":0.0802658274769783},{"x":1.675855278968811,"y":0.07652489840984344},{"x":1.753961443901062,"y":0.07311714440584183},{"x":1.8320677280426025,"y":0.06999995559453964},{"x":1.8320677280426025,"y":0.06999995559453964},{"x":1.9404642581939697,"y":0.062397826462984085},{"x":2.048860788345337,"y":0.05597006529569626},{"x":2.157257556915283,"y":0.05048667639493942},{"x":2.2656540870666504,"y":0.04577133059501648},{"x":2.3740508556365967,"y":0.04168701171875},{"x":2.482447385787964,"y":0.03812595084309578},{"x":2.590843915939331,"y":0.03500243276357651},{"x":2.6992406845092773,"y":0.03224761411547661},{"x":2.8076372146606445,"y":0.029805662110447884},{"x":2.9160337448120117,"y":0.027630940079689026},{"x":3.024430513381958,"y":0.025685828179121017},{"x":3.132827043533325,"y":0.02393910475075245},{"x":3.2412235736846924,"y":0.02236468344926834},{"x":3.3496203422546387,"y":0.020940624177455902},{"x":3.458016872406006,"y":0.019648371264338493},{"x":3.566413640975952,"y":0.01847214624285698},{"x":3.6748101711273193,"y":0.017398465424776077},{"x":3.7832067012786865,"y":0.01641574501991272},{"x":3.891603469848633,"y":0.015513993799686432}],"q":3.3000000000000003,"s":1.0,"ss":1.0,"st":1.0,"tb":0.08998104689697882,"tc":0.26994314069093645,"tcStar":0.26994314069093645,"td":1.8320676749136937,"year":474},{"ag":0.6763157371169074,"cc":1.0,"color":2131099799,"f0":2.8047461148459996,"name":"SLC","ni":0.303030303030303,"pointList":[{"x":0.0,"y":0.6763157248497009},{"x":0.09665680676698685,"y":0.5748163461685181},{"x":0.28997042775154114,"y":0.5748163461685181},{"x":0.28997042775154114,"y":0.5748163461685181},{"x":0.3692742586135864,"y":0.45137113332748413},{"x":0.4485781192779541,"y":0.3715735077857971},{"x":0.5278819799423218,"y":0.31575194001197815},{"x":0.6071857810020447,"y":0.2745119333267212},{"x":0.6864896416664124,"y":0.24280008673667908},{"x":0.76579350233078,"y":0.21765625476837158},{"x":0.8450973033905029,"y":0.19723141193389893},{"x":0.9244011640548706,"y":0.18031105399131775},{"x":1.0037050247192383,"y":0.16606447100639343},{"x":1.083008885383606,"y":0.15390431880950928},{"x":1.162312626838684,"y":0.1434035301208496},{"x":1.2416164875030518,"y":0.1342441439628601},{"x":1.3209203481674194,"y":0.12618455290794373},{"x":1.400224208831787,"y":0.11903789639472961},{"x":1.4795280694961548,"y":0.11265737563371658},{"x":1.5588319301605225,"y":0.10692605376243591},{"x":1.6381356716156006,"y":0.10174965113401413},{"x":1.7174395322799683,"y":0.09705130010843277},{"x":1.796743392944336,"y":0.09276769310235977},{"x":1.8760472536087036,"y":0.08884623646736145},{"x":1.982244849205017,"y":0.07958147674798965},{"x":2.08844256401062,"y":0.0716937929391861},{"x":2.1946401596069336,"y":0.06492320448160172},{"x":2.300837755203247,"y":0.05906831473112106},{"x":2.4070353507995605,"y":0.053971145302057266},{"x":2.513233184814453,"y":0.04950636625289917},{"x":2.6194307804107666,"y":0.04557354003190994},{"x":2.72562837600708,"y":0.04209139570593834},{"x":2.8318259716033936,"y":0.03899361193180084},{"x":2.938023567199707,"y":0.036225635558366776},{"x":3.0442211627960205,"y":0.033742260187864304},{"x":3.150418996810913,"y":0.0315057635307312},{"x":3.2566165924072266,"y":0.029484471306204796},{"x":3.36281418800354,"y":0.02765163779258728},{"x":3.4690117835998535,"y":0.025984540581703186},{"x":3.575209379196167,"y":0.024463782086968422},{"x":3.6814069747924805,"y":0.023072725161910057},{"x":3.787604808807373,"y":0.021797029301524162},{"x":3.8938024044036865,"y":0.020624279975891113},{"x":4.0,"y":0.019543692469596863}],"q":3.3000000000000003,"s":1.0,"ss":1.0,"st":1.0,"tb":0.09665681008027133,"tc":0.289970430240814,"tcStar":0.289970430240814,"td":1.8760472396395542,"year":974}],"tipologia":"Strutture a telaio, pareti accoppiate o miste"},"sismicParametersState":{"classeUso":1.0,"spectrums":[],"vitaNominale":50,"vitaReale":50.0},"sismogenticState":{"closedNodeData":[{"distance":3.936488342552018,"id":"13792","latitude":45.041,"longitude":7.619},{"distance":4.266951870949187,"id":"13571","latitude":45.095,"longitude":7.684},{"distance":2.767682541713376,"id":"13793","latitude":45.045,"longitude":7.689},{"distance":5.040599518447633,"id":"13570","latitude":45.091,"longitude":7.614}],"default_periods":[],"default_spectrum":[]}}}}'
    # bla = json.loads(test, strict=False)
    # """Render an HTML template and return"""
    # return jsonify(bla)#
    return render_template('hello.html')  # HTML file to be placed under sub-directory templates


if __name__ == '__main__':
    init_db()
    app.run(debug=True, host='192.168.0.11', port=5000)  # Launch built-in web server and run this Flask webapp
